networks:
  vlan10:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.10.0/24
    driver_opts:
      com.docker.network.bridge.name: br-vlan10

  vlan20:
    driver: bridge
    ipam:
      config:
        - subnet: 10.20.20.0/24
    driver_opts:
      com.docker.network.bridge.name: br-vlan20

  vlan30:
    driver: bridge
    ipam:
      config:
        - subnet: 10.30.30.0/24
    driver_opts:
      com.docker.network.bridge.name: br-vlan30

  wan:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
    driver_opts:
      com.docker.network.bridge.name: br-wan

services:
  # ============================================
  # ROUTER: Handles inter-VLAN routing + NAT + Firewall
  # ============================================
  router:
    build: ./router
    container_name: router
    hostname: router
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      vlan10:
        ipv4_address: 10.10.10.254
      vlan20:
        ipv4_address: 10.20.20.254
      vlan30:
        ipv4_address: 10.30.30.254
      wan:
        ipv4_address: 172.20.0.254
    environment:
      - VLAN10_SUBNET=10.10.10.0/24
      - VLAN20_SUBNET=10.20.20.0/24
      - VLAN30_SUBNET=10.30.30.0/24
      - WAN_SUBNET=172.20.0.0/24
    restart: unless-stopped

  # ============================================
  # DNS: CoreDNS serving demo.local zone
  # ============================================
  coredns:
    image: coredns/coredns:1.11.1
    container_name: coredns
    hostname: coredns
    command: ["-conf", "/etc/coredns/Corefile"]
    volumes:
      - ./coredns/Corefile:/etc/coredns/Corefile:ro
      - ./coredns/demo.local.zone:/zones/demo.local:ro
    networks:
      vlan10:
        ipv4_address: 10.10.10.53
      vlan20:
        ipv4_address: 10.20.20.53
    restart: unless-stopped

  # ============================================
  # DHCP: dnsmasq for VLAN20
  # ============================================
  dnsmasq:
    image: alpine:3.20
    container_name: dnsmasq
    hostname: dnsmasq
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "apk add --no-cache dnsmasq &&
             dnsmasq -d -C /etc/dnsmasq.conf"
    volumes:
      - ./dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf:ro
    networks:
      vlan20:
        ipv4_address: 10.20.20.2
    restart: unless-stopped

  # ============================================
  # APP: Nginx with HTTPS
  # ============================================
  nginx:
    image: nginx:1.27-alpine
    container_name: nginx-app
    hostname: app
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
      - ./nginx/html:/usr/share/nginx/html:ro
    networks:
      vlan10:
        ipv4_address: 10.10.10.10
    depends_on:
      - coredns
    restart: unless-stopped

  # ============================================
  # CLIENT10: Static IP client on VLAN10
  # ============================================
  client10:
    build: ./clients
    container_name: client10
    hostname: client10
    command: sh -c "sleep 2 && ip route del default && ip route add default via 10.10.10.254 && tail -f /dev/null"
    networks:
      vlan10:
        ipv4_address: 10.10.10.100
    dns:
      - 10.10.10.53
    dns_search:
      - demo.local
    extra_hosts:
      - "app.demo.local:10.10.10.10"
    cap_add:
      - NET_ADMIN
    restart: unless-stopped

  # ============================================
  # CLIENT20: DHCP client on VLAN20
  # ============================================
  client20:
    build: ./clients
    container_name: client20
    hostname: client20
    command: sh -c "sleep 3 && ip route del default 2>/dev/null || true && udhcpc -i eth0 -f -q && tail -f /dev/null"
    networks:
      vlan20: {}
    dns_search:
      - demo.local
    cap_add:
      - NET_ADMIN
    depends_on:
      - dnsmasq
      - coredns
    restart: unless-stopped

  # ============================================
  # VIZ: Network visualization webapp
  # ============================================
  viz:
    build: ./viz-webapp
    container_name: viz-webapp
    hostname: viz
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      vlan10:
        ipv4_address: 10.10.10.200
    depends_on:
      - router
      - coredns
      - nginx
    restart: unless-stopped

  # ============================================
  # SWITCH: Layer 2 Open vSwitch for VLAN30
  # ============================================
  switch:
    build: ./switch
    container_name: switch
    hostname: switch
    cap_add:
      - NET_ADMIN
    networks:
      vlan30:
        ipv4_address: 10.30.30.2
    restart: unless-stopped

  # ============================================
  # CLIENT30A: Client connected through switch
  # ============================================
  client30a:
    build: ./clients
    container_name: client30a
    hostname: client30a
    command: sh -c "sleep 3 && ip route del default && ip route add default via 10.30.30.254 && tail -f /dev/null"
    networks:
      vlan30:
        ipv4_address: 10.30.30.10
    cap_add:
      - NET_ADMIN
    depends_on:
      - switch
    restart: unless-stopped

  # ============================================
  # CLIENT30B: Client connected through switch
  # ============================================
  client30b:
    build: ./clients
    container_name: client30b
    hostname: client30b
    command: sh -c "sleep 3 && ip route del default && ip route add default via 10.30.30.254 && tail -f /dev/null"
    networks:
      vlan30:
        ipv4_address: 10.30.30.20
    cap_add:
      - NET_ADMIN
    depends_on:
      - switch
    restart: unless-stopped

  # ============================================
  # WAN_HOST: Simulated external host with HTTP service
  # ============================================
  wan_host:
    image: alpine:3.20
    container_name: wan-host
    hostname: wan-host
    command: >
      sh -c "apk add --no-cache python3 &&
             echo 'Hello from WAN!' > /tmp/index.html &&
             echo 'Starting HTTP server on port 8080...' &&
             python3 -m http.server 8080 --directory /tmp"
    networks:
      wan:
        ipv4_address: 172.20.0.100
    restart: unless-stopped

  # ============================================
  # WAN_SERVICE: External service for PAT demo (port forwarding target)
  # ============================================
  wan_service:
    image: nginx:1.27-alpine
    container_name: wan-service
    hostname: wan-service
    command: >
      sh -c "echo '<h1>External Service</h1><p>This is an external service accessible via PAT port forwarding</p>' > /usr/share/nginx/html/index.html &&
             nginx -g 'daemon off;'"
    networks:
      wan:
        ipv4_address: 172.20.0.200
    restart: unless-stopped

